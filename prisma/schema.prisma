// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  HOST
  SERVER
  MANAGER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum TableStatus {
  AVAILABLE
  BOOKED
  SEATED
  DIRTY
  RESERVED
  OUT_OF_SERVICE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

enum Channel {
  WEBSITE
  MOBILE_APP
  GOOGLE_RESERVE
  INSTAGRAM
  FACEBOOK
  PHONE
  WALK_IN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  image         String?
  emailVerified DateTime?
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  bookings      Booking[]
  favoriteRestaurants FavoriteRestaurant[]
  reviews       Review[]
  loyaltyPoints LoyaltyPoints[]
  guestNotes    GuestNote[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token      String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Restaurant {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String?  @db.Text
  address           String
  city              String
  state             String?
  zipCode           String?
  country           String
  phone             String
  email             String
  website           String?
  logo              String?
  coverImage        String?
  cuisine           String?
  priceRange        Int?     // 1-4
  timeZone          String   @default("UTC")
  
  // Operating hours
  mondayOpen        String?
  mondayClose       String?
  tuesdayOpen       String?
  tuesdayClose      String?
  wednesdayOpen     String?
  wednesdayClose    String?
  thursdayOpen      String?
  thursdayClose     String?
  fridayOpen        String?
  fridayClose       String?
  saturdayOpen      String?
  saturdayClose     String?
  sundayOpen        String?
  sundayClose       String?
  
  // Booking settings
  bookingBufferMinutes Int     @default(15)
  minPartySize        Int     @default(1)
  maxPartySize        Int     @default(20)
  requireDeposit      Boolean @default(false)
  depositAmount       Float?
  depositPercentage   Float?
  noShowPolicy        String? @db.Text
  cancellationPolicy  String? @db.Text
  
  // Features
  allowTableSelection Boolean @default(true)
  allowPreOrder       Boolean @default(false)
  allowWaitlist       Boolean @default(true)
  multiLanguage       Boolean @default(false)
  languages           String[] // ["en", "es", "fr"]
  
  // Branding
  primaryColor        String?
  secondaryColor      String?
  fontFamily          String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  floors              Floor[]
  tables              Table[]
  bookings            Booking[]
  staff               Staff[]
  shifts              Shift[]
  specialHours        SpecialHours[]
  events              Event[]
  menuItems           MenuItem[]
  favoriteRestaurants FavoriteRestaurant[]
  reviews             Review[]
  waitlist            Waitlist[]
  promoCodes          PromoCode[]
  customFields        CustomField[]
  integrations        Integration[]
}

model Floor {
  id           String   @id @default(cuid())
  restaurantId String
  name         String
  level        Int      @default(1)
  floorPlan    Json?    // SVG or image data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  tables     Table[]

  @@index([restaurantId])
}

model Table {
  id           String      @id @default(cuid())
  restaurantId String
  floorId      String?
  name         String      // "Table 1", "Booth 5"
  number       Int
  capacity     Int         // Max party size
  minPartySize Int?        // Min party size
  x            Float?      // Position on floor plan
  y            Float?      // Position on floor plan
  shape        String?     // "circle", "rectangle", "square"
  status       TableStatus @default(AVAILABLE)
  section      String?     // Server section
  notes        String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  floor      Floor?     @relation(fields: [floorId], references: [id], onDelete: SetNull)
  bookings   Booking[]
  combinations TableCombination[]

  @@index([restaurantId])
  @@index([floorId])
  @@index([status])
}

model TableCombination {
  id        String   @id @default(cuid())
  name      String   // "Large Party Setup"
  tables    Table[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id                String        @id @default(cuid())
  restaurantId      String
  userId            String?
  tableId           String?
  status            BookingStatus @default(PENDING)
  channel           Channel
  partySize         Int
  date              DateTime
  time              String        // "19:00"
  duration          Int           @default(120) // minutes
  specialRequests   String?       @db.Text
  guestName          String
  guestEmail         String
  guestPhone         String
  notes              String?       @db.Text
  tags               String[]      // ["VIP", "regular", "allergy"]
  isWalkIn           Boolean       @default(false)
  seatedAt           DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?       @db.Text
  noShowAt           DateTime?
  
  // Payment
  depositAmount      Float?
  depositPaid        Boolean       @default(false)
  totalAmount        Float?
  paymentStatus      PaymentStatus @default(PENDING)
  
  // Pre-orders
  preOrderItems      Json?         // Array of menu items
  
  // Calendar
  calendarEventId    String?       // Google/Outlook calendar ID
  
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  table      Table?     @relation(fields: [tableId], references: [id], onDelete: SetNull)
  payments   Payment[]
  reminders  Reminder[]
  review     Review?

  @@index([restaurantId])
  @@index([userId])
  @@index([tableId])
  @@index([date])
  @@index([status])
  @@index([channel])
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String
  amount        Float
  currency      String        @default("USD")
  status        PaymentStatus @default(PENDING)
  stripePaymentId String?     @unique
  refundAmount  Float?
  refundedAt    DateTime?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([stripePaymentId])
}

model Staff {
  id           String   @id @default(cuid())
  restaurantId String
  userId       String?  // If linked to User account
  name         String
  email        String
  phone        String?
  role         UserRole
  section      String?  // Server section
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@unique([restaurantId, email])
}

model Shift {
  id           String   @id @default(cuid())
  restaurantId String
  name         String   // "Lunch", "Dinner", "Brunch"
  startTime    String   // "11:00"
  endTime      String   // "15:00"
  daysOfWeek   Int[]    // [1,2,3,4,5] for Mon-Fri
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
}

model SpecialHours {
  id           String   @id @default(cuid())
  restaurantId String
  date         DateTime
  openTime     String?
  closeTime    String?
  closed       Boolean  @default(false)
  reason       String?  // "Holiday", "Private Event"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId, date])
}

model Event {
  id           String   @id @default(cuid())
  restaurantId String
  name         String
  description  String?  @db.Text
  startDate    DateTime
  endDate      DateTime
  isRecurring  Boolean  @default(false)
  recurrenceRule String? @db.Text // iCal format
  privateRoom  Boolean  @default(false)
  capacity     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([startDate])
}

model MenuItem {
  id           String   @id @default(cuid())
  restaurantId String
  name         String
  description  String?  @db.Text
  price        Float
  category     String
  image        String?
  available    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
}

model FavoriteRestaurant {
  id           String   @id @default(cuid())
  userId       String
  restaurantId String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
}

model Review {
  id           String   @id @default(cuid())
  restaurantId String
  userId       String
  bookingId    String?  @unique
  rating       Int      // 1-5
  comment      String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking    Booking?   @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([restaurantId])
  @@index([userId])
}

model LoyaltyPoints {
  id           String   @id @default(cuid())
  userId       String
  restaurantId String
  points       Int      @default(0)
  totalEarned  Int      @default(0)
  totalRedeemed Int     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
}

model GuestNote {
  id           String   @id @default(cuid())
  restaurantId String
  userId       String
  note         String   @db.Text
  tags         String[] // ["allergy", "preference", "VIP"]
  createdBy    String   // Staff user ID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId, userId])
}

model Waitlist {
  id           String   @id @default(cuid())
  restaurantId String
  userId       String?
  partySize    Int
  date         DateTime
  time         String
  guestName    String
  guestEmail   String
  guestPhone   String
  notified     Boolean  @default(false)
  notifiedAt   DateTime?
  status       String   @default("WAITING") // WAITING, SEATED, CANCELLED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([restaurantId])
  @@index([date])
}

model Reminder {
  id           String   @id @default(cuid())
  bookingId    String
  type         String   // "24h", "2h", "post_visit"
  sentAt       DateTime?
  emailSent    Boolean  @default(false)
  smsSent      Boolean  @default(false)
  createdAt    DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model PromoCode {
  id           String   @id @default(cuid())
  restaurantId String
  code         String
  description  String?  @db.Text
  discountType String   // "PERCENTAGE", "FIXED"
  discountValue Float
  minBookingAmount Float?
  maxUses      Int?
  usedCount    Int      @default(0)
  validFrom    DateTime
  validUntil   DateTime
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, code])
  @@index([restaurantId])
}

model CustomField {
  id           String   @id @default(cuid())
  restaurantId String
  name         String
  type         String   // "TEXT", "NUMBER", "SELECT", "CHECKBOX"
  required     Boolean  @default(false)
  options      Json?    // For SELECT type
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
}

model Integration {
  id           String   @id @default(cuid())
  restaurantId String
  type         String   // "POS", "KDS", "GOOGLE_CALENDAR", "FACEBOOK", "INSTAGRAM"
  name         String
  config       Json     // API keys, settings
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([type])
}

model AuditLog {
  id           String   @id @default(cuid())
  restaurantId String?
  userId       String?
  action       String   // "CREATE_BOOKING", "UPDATE_TABLE", etc.
  entityType   String   // "Booking", "Table", etc.
  entityId     String?
  changes      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([restaurantId])
  @@index([userId])
  @@index([createdAt])
}

